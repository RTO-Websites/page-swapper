var PageSwapper=function(args){var win=window,doc=win.document,self=this,defaultArgs={disableCache:false,debug:false,owlConfig:{},owlVersion:2,},owlDefaultArgs={margin:20,mouseDrag:false,touchDrag:false,disableHash:false},container=null,host=win.location.protocol+'//'+win.location.host,currentUrl=win.location.href,hash='',initFailed=false,pswXhr=null;var init=function(){if(!win.$){win.$=jQuery}args=$.extend(defaultArgs,args);args.id='page-swapper';container=$($(args.container)[0]);if(container.is('body')){container.wrapInner('<div class="psw-body"></div>');container=container.find('> .psw-body')}container.wrapInner('<div class="tab psw-starttab psw-tab"></div>');$('body').on('click','a:not(a[href*=".jpg"], a[href*=".jpeg"], a[href*=".png"], a[href*=".gif"], a[href*=".JPG"], a[href*=".GIF"], a[href*=".PNG"], a[href*=".JPEG"])',self.linkClick);$(win).on('popstate',function(){self.open(doc.location.href)});var owlArgs=$.extend(owlDefaultArgs,args.owlConfig);owlArgs=$.extend(owlArgs,{items:1,singleItem:true,autoHeight:true,});container.addClass('psw-container');try{container.owlCarousel(owlArgs)}catch(e){initFailed=true;console.info('psw-init-error',e,container,owlArgs);return}var curTab=container.find('.psw-starttab');curTab.attr('data-url',win.location.href);curTab.data('title',doc.title);curTab.data('bodyclass',$('body').prop('class').replace('no-js',''));curTab.data('originalhtml','');debug('psw init',self,container,args);if(container.data('owl.carousel')&&container.data('owl.carousel')._plugins&&container.data('owl.carousel')._plugins.autoHeight){setInterval(function(){container.data('owl.carousel')._plugins.autoHeight.update()},300)}self.setClasses()};self.setArgs=function(newArgs){args=$.extend(args,newArgs)};self.linkClick=function(event){if(!event||!event.target||initFailed){return}var clickedElement=$(event.target);if(!clickedElement.is('a')){clickedElement=clickedElement.closest('a')}if(!clickedElement.prop('href')){return}if(clickedElement.hasClass('no-ajax')){return}var url=clickedElement.prop('href');if(url.indexOf(host)===-1){return}if(url.indexOf('mailto:')!==-1){return}var filteredFileEndings=['zip','exe','rar','pdf','doc','gif','png','jpg','jpeg','bmp','mp4','mp3'],fileEnding=url.split('.');fileEnding=fileEnding[fileEnding.length-1];if($.inArray(fileEnding,filteredFileEndings)!==-1){return}event.preventDefault();self.open(url,event)};self.open=function(url,event){var splittedUrl=url.split('#');hash='';url=splittedUrl[0];if(typeof(splittedUrl[1])!=='undefined'){hash=splittedUrl[1]}container.trigger('psw-beforeopen',{'container':container,'url':url,'hash':hash,'currentUrl':currentUrl,'clickEvent':event,});debug('psw beforeOpen',self,container,args,url,hash,currentUrl);if(currentUrl===url){checkHash();return}var hasCache=checkForCache(url);if(hasCache){return}$('body').removeClass('psw-finish-loading').addClass('psw-loading');if(pswXhr){pswXhr.abort();pswXhr=null}pswXhr=$.ajax({dataType:'text',type:'GET',url:url,data:{pswLoad:1},success:function(data,textStatus,jqXHR){loadComplete(data,textStatus,url,jqXHR)},error:function(){$('body').removeClass('psw-loading');$('body').addClass('psw-loaderror');errorTimeout=setTimeout(function(){$('body').removeClass('psw-loaderror')},1000)}});container.trigger('psw-loadstart',{'container':container,'url':url,'hash':hash,'currentUrl':currentUrl,'clickEvent':event,});debug('psw loadstart',self,container,args,url,hash,currentUrl)};var loadComplete=function(data,textStatus,url,jqXHR){$('body').removeClass('psw-loading').addClass('psw-finish-loading');var newTab=$('<div class="tab psw-tab" />'),currentTab=self.getCurrent(),title='',bodyClass='';if(!jqXHR){return false}var contentHeader=jqXHR.getResponseHeader('Content-Type');if(contentHeader.indexOf('text/html')===-1){return false}debug('psw loadComplete',self,container,args,url,hash,currentUrl,jqXHR);title=getTitleFromData(data);tabData=getTabFromData(data);content=tabData.content;bodyClass=tabData.bodyClass;if(args.owlVersion==1){container.data('owlCarousel').addItem(newTab);self.setClasses()}else{container.trigger('add.owl.carousel',newTab);container.trigger('refresh.owl.carousel')}addIdPrefixes(currentTab);newTab.data('originalhtml',content.html());setHtmlToTab(newTab,content);changeUrl(url,title);newTab.attr('data-url',url).data('title',title);newTab.data('bodyclass',bodyClass);newTab.parent().addClass('psw-item');finish(newTab.parent(),{'container':container,'oldTab':currentTab,'newTab':newTab.parent(),'url':url,'currentUrl':currentUrl})};self.openFromCache=function(element,url){var currentItem=self.getCurrent();addIdPrefixes(currentItem);removeIdPrefixes(element.parent());var orgHtml=element.data('originalhtml');if(!orgHtml||!orgHtml.length){getOriginalHtml(element)}else{element.empty().html(orgHtml)}changeUrl(url,element.data('title'));debug('psw openFromCache',url,element,orgHtml);var bodyClass=element.data('bodyclass');if(args.selector==='body'){bodyClass+=' page-swapper '}$('body').removeClass($('body').prop('class')).addClass(bodyClass);finish(element.parent(),{'container':container,'oldTab':self.getCurrent(),'newTab':element.parent(),'url':url,})};var finish=function(owlItem,callbackArgs){container.trigger('psw-loadcomplete',callbackArgs);self.jumpTo(owlItem.index());debug('psw finish',owlItem,owlItem.index());if(typeof _gaq!=="undefined"&&_gaq!==null){_gaq.push(['_trackPageview',args.url])}if(typeof(ga)!=='undefined'&&ga!==null){ga('send','pageview',location.pathname)}if(typeof(Piwik)!=='undefined'&&Piwik!==null){var tracker=Piwik.getTracker();tracker.setCustomUrl(window.location.href);tracker.setDocumentTitle(document.title);tracker.trackPageView()}};self.jumpTo=function(index){if(args.owlVersion==1){console.info('jump',index,container.data('owlCarousel'));container.data('owlCarousel').goTo(index)}else{container.trigger('to.owl.carousel',index)}};var checkForCache=function(url){var cacheElement=container.find('.psw-tab[data-url="'+url+'"]');if(!cacheElement.length){cacheElement=container.find('.psw-tab[data-url="'+url+'/"]')}if(cacheElement.length>0){self.openFromCache(cacheElement,url);return true}return false};var checkHash=function(){debug('psw checkHash',self,container,args,hash,currentUrl);if(!args.disableHash&&hash&&$('#'+hash).length>0){$('html,body').animate({scrollTop:$('#'+hash).offset().top},600);hash=''}};var addIdPrefixes=function(tab){tab.find('*').each(function(index,element){if(element.id.length>0){element.id='psw-rm-'+element.id}})};var removeTab=function(tab){if(args.owlVersion==1){container.data('owlCarousel').removeItem(tab.index());self.setClasses()}else{container.trigger('remove.owl.carousel',tab.index());container.trigger('refresh.owl.carousel')}};var removeIdPrefixes=function(tab){tab.find('*').each(function(index,element){if(element.id.length>0){element.id=element.id.replace('psw-rm-','')}})};self.setClasses=function(){container.addClass('psw-container');container.addClass('owl-carousel');container.find('> .owl-stage-outer, > .owl-wrapper-outer').addClass('psw-stage-outer');container.find('> .owl-stage-outer > .owl-stage, > .owl-wrapper-outer > .owl-wrapper').addClass('psw-stage');container.find('.psw-stage > .owl-item').addClass('psw-item')};self.getCurrent=function(){var curTab;if(args.owlVersion==1){curTab=container.find('.psw-item:nth-child('+container.data('owlCarousel').currentItem+')')}else{curTab=container.find('.psw-item.active')}return curTab};var changeUrl=function(url,title){currentUrl=url;if(win.history&&typeof(win.history.pushState)!=='undefined'){win.history.pushState({},title,url);doc.title=jQuery('<textarea />').html(title).text()}};var getTabFromData=function(data){data=data.replace('<body','<body><div id="psw-body"').replace('</body>','</div></body');var newHtml=$.parseHTML(data,true),bodyClass;newHtml=$(newHtml);if(newHtml.filter('#psw-body').length>0){bodyClass=newHtml.filter('#psw-body').prop('class').replace('no-js','');var oldClasses=$('body').prop('class');if(args.selector==='body'){bodyClass+=' page-swapper '}$('body').removeClass(oldClasses).addClass(bodyClass)}var content=newHtml.find(args.selector);if(content.length===0){content=newHtml.filter('#psw-body')}return{content:content,bodyClass:bodyClass}};var getOriginalHtml=function(tab){debug('psw getOrgHtml',tab,tab.data('url'));pswXhr=$.ajax({dataType:'text',type:'GET',url:tab.data('url'),data:{pswLoad:1},success:function(data,textStatus,jqXHR){var content=getTabFromData(data).content;tab.data('originalhtml',content.html());setHtmlToTab(tab,content);debug('psw getOrgHtml finish',tab,content.html())},})};var setHtmlToTab=function(tab,content){try{tab.empty().html(content.html())}catch(e){content.find('script').remove();tab.empty().html(content.html())}};var getTitleFromData=function(data){var title=data.match(/<title>(.*?)<\/title>/);if(title&&title[1]){title=title[1]}else{title=''}return title};self.changeCurrentUrl=function(url){currentUrl=url};var debug=function(){if(args.debug){console.info(arguments)}};self._debug=function(debug){args.debug=debug};init()};jQuery.fn.pageSwapper=function(args){if(typeof(args)==='undefined'){args={}}args.selector=this.selector;this.each(function(index,element){if(typeof(document.pageSwapperInstance)==='undefined'){args.container=jQuery(element);document.pageSwapperInstance=new PageSwapper(args)}})};